# Ubuntu 24.04 ECS部署指南

## 项目概述
本项目是一个AI角色自主行为生成系统，包含前端（React + TypeScript + Vite）和后端（Node.js + Express + SQLite）两个部分。

## 部署环境
- 服务器：阿里云/腾讯云ECS实例
- 操作系统：Ubuntu 24.04 LTS
- 最低配置：2核CPU，4GB内存，40GB磁盘空间

---

## 第一步：服务器准备

### 1. 连接服务器
使用SSH工具连接到您的ECS实例（替换为您的实际IP地址）：
```bash
ssh root@192.168.1.100
```

### 2. 更新系统
```bash
sudo apt update && sudo apt upgrade -y
```

### 3. 安装必要依赖
```bash
sudo apt install -y git wget curl build-essential
```

---

## 第二步：安装Node.js

### 1. 安装Node.js 18
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs
```

### 2. 验证安装
```bash
node --version  # 应该显示 v18.x.x
npm --version   # 应该显示 v9.x.x
```

---

## 第三步：部署项目

### 1. 克隆项目代码
```bash
cd /opt
git clone <您的项目仓库地址>
cd AgentCircle
```

### 2. 安装后端依赖
```bash
cd backend
npm install
```

### 3. 安装前端依赖并构建
```bash
cd ../frontend
npm install
npm run build
```

---

## 第四步：配置服务

### 1. 安装PM2进程管理器（用于管理后端服务）
```bash
sudo npm install -g pm2
```

### 2. 创建PM2配置文件
在项目根目录创建 `ecosystem.config.js`：
```javascript
module.exports = {
  apps: [
    {
      name: 'ai-character-backend',
      script: './backend/src/app.js',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
      env: {
        NODE_ENV: 'production',
        PORT: 8002
      }
    }
  ]
};
```

### 3. 启动后端服务
```bash
cd /opt/AgentCircle
pm2 start ecosystem.config.js
```

### 4. 设置PM2开机自启
```bash
pm2 startup
pm2 save
```

---

## 第五步：安装并配置Nginx

### 1. 安装Nginx
```bash
sudo apt install -y nginx
```

### 2. 编辑Nginx配置文件
```bash
sudo nano /etc/nginx/sites-available/ai-character
```

添加以下配置：
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名或IP地址

    # 前端静态文件
    location / {
        root /opt/AgentCircle/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://localhost:8002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 3. 启用配置
```bash
sudo ln -s /etc/nginx/sites-available/ai-character /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

## 第六步：防火墙配置

### 1. 安装ufw防火墙
```bash
sudo apt install -y ufw
```

### 2. 允许必要端口
```bash
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 8002

# 启用防火墙
sudo ufw --force enable
```

### 3. 检查防火墙状态
```bash
sudo ufw status
```

---

## 第七步：域名绑定（可选）

### 1. 购买域名
在域名注册商（如阿里云、腾讯云、Godaddy等）购买域名。

### 2. DNS解析
将域名解析到您的服务器IP地址：
- 主机记录：@ 或 www
- 记录类型：A
- 记录值：您的服务器公网IP地址

### 3. 安装SSL证书（启用HTTPS）
```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 申请SSL证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 验证SSL证书
sudo certbot renew --dry-run
```

---

## 第八步：测试项目

### 1. 检查后端服务状态
```bash
pm2 status
pm2 logs
```

### 2. 测试网站访问
在浏览器中访问：
- `http://your-domain.com` 或 `http://your-server-ip`
- `http://your-domain.com/api/stats`（检查API是否正常）

---

## 第九步：常见问题排查

### 1. 前端无法访问后端API
- 检查后端服务是否正常运行：`pm2 status`
- 检查防火墙是否允许8002端口：`sudo ufw status`
- 检查Nginx配置是否正确：`sudo nginx -t`

### 2. 数据库连接失败
- 检查数据库文件是否存在：`ls -la /opt/AgentCircle/backend/src/database/`
- 检查后端服务日志：`pm2 logs ai-character-backend`

### 3. 前端页面无法加载
- 检查前端构建文件是否存在：`ls -la /opt/AgentCircle/frontend/dist/`
- 检查Nginx配置是否正确：`sudo nginx -t`

---

## 维护与更新

### 1. 项目更新
```bash
cd /opt/AgentCircle
git pull
cd backend
npm install
cd ../frontend
npm install
npm run build
pm2 restart ai-character-backend
sudo nginx -t
sudo systemctl reload nginx
```

### 2. 备份数据库
```bash
cp /opt/AgentCircle/backend/src/database/ai_characters.db /opt/AgentCircle/backend/src/database/ai_characters.db.backup.$(date +%Y%m%d)
```

---

## 相关文件位置

- 项目根目录：`/opt/AgentCircle`
- 前端构建文件：`/opt/AgentCircle/frontend/dist`
- 后端代码：`/opt/AgentCircle/backend/src`
- 数据库文件：`/opt/AgentCircle/backend/src/database/ai_characters.db`
- Nginx配置文件：`/etc/nginx/sites-available/ai-character`
- PM2配置文件：`/opt/AgentCircle/ecosystem.config.js`

---

## 联系方式

如果您在部署过程中遇到问题，可以通过以下方式联系我们：
- 查看项目README文件
- 检查项目issue
- 联系项目维护者